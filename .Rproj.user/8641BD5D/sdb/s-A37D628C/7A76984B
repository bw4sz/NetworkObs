{
    "contents" : "---\ntitle: \"Trait-matching and Resources Simulation\"\nauthor: \"Ben Weinstein\"\ndate: \"3/11/2016\"\noutput: \n  html_document:\n    toc: true\n    number_sections: true\n    theme: spacelab\n    keep_md: true\n---\n\n```{r,warning=FALSE,message=FALSE,echo=FALSE,cache=FALSE}\nlibrary(reshape2)\nlibrary(chron)\nlibrary(ggplot2)\nlibrary(knitr)\nlibrary(R2jags)\nlibrary(dplyr)\nlibrary(stringr)\nlibrary(gridExtra)\nlibrary(boot)\nlibrary(picante)\nlibrary(bipartite)\n\nopts_chunk$set(message=FALSE,warning=FALSE,fig.width=12,fig.height=4,echo=TRUE,cache=FALSE,cache.path = 'jp_cache/',fig.align='center',fig.path=\"figure/\")\n\nset.seed(3)\n#source functions\n\nsource(\"Bayesian/BayesFunctions.R\")\n```\n\n#Rationale\n\nIn the paper we suggest a model of species interactons based on trait values. An alterantive, or complimentary, mechanism may be that the frequency at which a hummingbird i interacts with a flower j is shaped by the abundance of flower j at time k.   \n\nThe key change from eq1 in the main analysis is:\n\n$$log(\\lambda_{i,j,k})<-\\alpha_i + \\beta_i * |Bill_i - Corolla_j| * \\beta_2 * Abundances_{j,k} + \\beta_3 * Resources_{j,k} * |Bill_i - Corolla_j| $$\n\nIn this extension, the interpretation of $β_1$ would be the effect of bill matching on the frequency of interactions, $β_2$ the influence of increasing abundance of resources on the frequency of interactions, and β_3 the interaction effect between resources and abundance. For example, a negative interaction effect would mean that as resources become more common, birds use flowers that are less similar to their bill lengths. This result would suggest the importance of choosing a matched resource is less important when encounter rates are high (Robinson & Wilson 1998). In contrast, a positive interaction effect would mean that hummingbirds choose highly matched resources as they become more abundant. This result would suggest niche partitioning to exclude potential competitors based on morphological diversity (Correa & Winemiller 2014). \n\n##Caveats\n\nIn this simulation, we get to ignore some of the thornier questions that would arise using empirical data. There are a number of challenging questions that would need to be answered from a methodological perspective.\n\n1. N-mixture models depend on a closed state. Given that phenology of flowers may not match the timing of camera events, what is the temporal overlap required? Collecting the data to define the abundance of flower j at time k is the key question. Once we can agree on a metric, incorporating it into the model is more straightforward. \n\n2. Is it the abundance of the flower being filmed that structures the frequency of interactions? Or is it the relative abundance to other food sources? Whose other food sources? All species? Just the abundance of resources used by that species based on the dataset?\n\n3. It seems reasonable that abundance measure need to be spatially limited. From how far away should we include abundance information? Presumably this would be based on the foraging pattern of each hummingbird species (perhaps using RFID or other data telemetry data). This information doesn’t yet exist (but see (Hadley & Betts 2009)). \n\n#Simulation   \n\n## Parameters\n\n* 3 hummingbird species\n* Range of hummingbird bill sizes (mm) ~ Poisson(2)\n* 10 plants\n* Range of corolla sizes (mm) ~ Poisson(2)\n* Mean frequent ($\\lambda$) for each hummingbird is drawn from U(0,10)  \n* Trait matching (minimizing Bill-Corolla difference) is drawn from a \nhierarchical distribution\n\n$$log(\\lambda_{i,j,k})<-\\alpha_i + \\beta_i * |Bill_i - Corolla_j| * \\beta_2 * Abundances_{j,k} + \\beta_3 * Resources_{j,k} * |Bill_i - Corolla_j| $$\n\n* 24 month replicates\n* Flower availability is log normally distribution (mu=20)\n\n```{r,fig.height=5,fig.width=8}\n#function that can be used to test different parameters\nsim<-function(gamma1,gamma2,gamma3){\n\n#Number of hummingbird species\nh_species=3\nplant_species=20\nmonths=30\ndetection=runif(h_species,0,1)\nphenology=1\n\n#Bill sizes\nBill<-rpois(h_species,10)\n\n#Corolla sizes\nCorolla<-rpois(plant_species,15)\n\n#Subtract both and take absolute value\ntraitmatch<-abs(sapply(Corolla,function(x) x - Bill)/10)\n\n#fill out for each month\ntraitarray<-array(NA,dim=c(h_species,plant_species,months))\n#fill for each month\nfor (x in 1:months){\n  traitarray[,,x]<-traitmatch \n}\n\n#simulate some poisson distributed resource counts for each replicate\n#this will be same for each species to start with.\nresources<-array(NA,dim=c(h_species,plant_species,months))\n\n#fill for each month\nfor (x in 1:months){\n  resources[,,x]<-rpois(1,10)  \n}\n\n#standardize predictors\n\nresources<-array(data=scale(resources),dim=c(h_species,plant_species,months))\n#traitarray<-array(data=scale(traitarray),dim=c(h_species,plant_species,months))\n\n#regression slope for trait-matching and resources\n#trait match\n#gamma=-0.5\nintercept<-2\nsigma_slope1<- 0.1\nsigma_intercept<- 0.1\n\n#resources\n#gamma2=0\nsigma_slope2<- 0.1\n\n#resources * traitmatch\n#gamma3=0\nsigma_slope3<- 0.1\n\n#loop through each species and plants\n\n#draw values from hierarcichal distributions\nbeta1<-rnorm(h_species,gamma1,sigma_slope1)\nbeta2<-rnorm(h_species,gamma2,sigma_slope2)\nbeta3<-rnorm(h_species,gamma3,sigma_slope3)\n\nalpha<-rnorm(h_species,intercept,sigma_intercept)\n\n#fit regression\nlambda<-exp(alpha + beta1 * traitarray + beta2 * resources + beta3 * resources * traitarray)\n\ntrue_interactions<-array(data=sapply(lambda,function(x){rpois(1,lambda=x)}),dim=c(h_species,plant_species,months))\n\n#combine and melt into a single datafFrame\nmdat<-dcast(melt(list(y=true_interactions,traitmatch=traitarray,resources=resources)),Var1+Var2+Var3~L1)\nreturn(mdat)}\n```\n\n#Patterns and Inference\n\nWe can image five important biological scenerios.\n\n* Model 1: Increased resources have no effect on visitation\n* Model 2: Increased resources have positive effect on visitation\n* Model 3: Increased resources have negative effect on visitation\n* Model 4: As resources increase, hummingbirds interact **more** with plants that match their bill length. \n* Model 5: As resources increase, hummingbirds interact **less** with plants that match their bill length. \n\nFor each of these scenerios, let's simulate some data to view what the model would look like. We first do this before accounting for detection bias to get a clear idea of the mechanisms involved. Adding the detection model is equivalent regardless of the underlying process model.\n\n## Species interactions are based solely on trait matching. No effect of resources and no interaction effect.\n\n```{r}\nmdat<-sim(-.5,0,0)\nggplot(mdat,aes(col=resources,y=y,x=traitmatch)) + geom_point() + geom_smooth(aes(group=1),method=\"glm\",method.args = list(family = \"poisson\")) + theme_bw() + labs(x=\"Bill-Corolla Difference\",y=\"Visits\",\"Hummingbird\") + ggtitle(\"Simulated data for each species\") + labs(col=\"Available Resources\") + scale_color_continuous(low=\"blue\",high=\"red\",breaks=c(-1.5,0,1.5),labels=c(\"Resource Poor\",\"\",\"Resource Rich\")) + facet_wrap(~Var1,nrow=1)\n```\n\n## Species interactions are based on similarity in morphology and abundance of resources, without an interaction. As resources increase, species interact more with all resources. Red points on top, blue on the bottom.\n\n```{r}\nmdat<-sim(-0.5,1,0)\nggplot(mdat,aes(col=resources,y=y,x=traitmatch)) + geom_point() + geom_smooth(aes(group=1),method=\"glm\",method.args = list(family = \"poisson\"),formula=y~x) + theme_bw() + labs(x=\"Bill-Corolla Difference\",y=\"Visits\",\"Hummingbird\") + ggtitle(\"Simulated data for each species\") + labs(col=\"Available Resources\") + scale_color_continuous(low=\"blue\",high=\"red\",breaks=c(-1.5,0,1.5),labels=c(\"Resource Poor\",\"\",\"Resource Rich\")) + facet_wrap(~Var1,nrow=1)\n```\n\n## Species interactions are based on similarity in morphology and abundance of resources, without an interaction. As resources decrease, species interact more with all resources. Blue on top, red on the bottom.\n\n```{r}\nmdat<-sim(-0.5,-1,0)\nggplot(mdat,aes(col=resources,y=y,x=traitmatch)) + geom_point() + geom_smooth(aes(group=1),method=\"glm\",method.args = list(family = \"poisson\"),formula=y~x) + theme_bw() + labs(x=\"Bill-Corolla Difference\",y=\"Visits\",\"Hummingbird\") + ggtitle(\"Simulated data for each species\") + labs(col=\"Available Resources\") + scale_color_continuous(low=\"blue\",high=\"red\",breaks=c(-1.5,0,1.5),labels=c(\"Resource Poor\",\"\",\"Resource Rich\")) + facet_wrap(~Var1,nrow=1)\n```\n\n## Species interactions are based on similarity in morphology and abundance of resources, with an interaction. As resources increase, hummingbirds interact **more** with plants that match their bill length.\n\n```{r}\nmdat<-sim(-0.5,0,-0.5)\nggplot(mdat,aes(col=resources,y=y,x=traitmatch)) + geom_point() + geom_smooth(aes(group=1),method=\"glm\",method.args = list(family = \"poisson\"),formula=y~x) + theme_bw() + labs(x=\"Bill-Corolla Difference\",y=\"Visits\",\"Hummingbird\") + ggtitle(\"Simulated data for each species\") + labs(col=\"Available Resources\") + scale_color_continuous(low=\"blue\",high=\"red\",breaks=c(-1.5,0,1.5),labels=c(\"Resource Poor\",\"\",\"Resource Rich\")) + facet_wrap(~Var1,nrow=1)\n```\n\n## Species interactions are based on similarity in morphology and abundance of resources, with an interaction.As resources increase, hummingbirds interact **less** with plants that match their bill length.\n\n```{r}\nmdat<-sim(.1,0,.5)\nggplot(mdat,aes(col=resources,y=y,x=traitmatch)) + geom_point() + geom_smooth(aes(group=1),method=\"glm\",method.args = list(family = \"poisson\"),formula=y~x) + theme_bw() + labs(x=\"Bill-Corolla Difference\",y=\"Visits\",\"Hummingbird\") + ggtitle(\"Correlation in Simulated Data\") + labs(col=\"Available Resources\") + scale_color_continuous(low=\"blue\",high=\"red\",breaks=c(-1.5,0,1.5),labels=c(\"Resource Poor\",\"\",\"Resource Rich\")) + facet_wrap(~Var1,nrow=1)\n```\n\nLet's look at that estimate for each of the cases we just outlined.\n\n```{r}\nsim1<-sim(.5,0,0)\nsim2<-sim(.5,1,0)\nsim3<-sim(.5,-1,0)\nsim4<-sim(.5,0,-1)\nsim5<-sim(.5,0,1)\nsims<-list(sim1,sim2,sim3,sim4,sim5)\nnames(sims)<-as.character(1:5)\n\ns<-melt(sims,id.vars=colnames(sim1))\nmodlist<-list()\nfor (x in 1:length(sims)){\nmod<-glm(data=sims[[x]],y~resources*traitmatch,family = \"poisson\")\ncond<-mod$coefficients[3] + mod$coefficients[4] * mod$data$traitmatch\nd<-data.frame(R_effect=cond,traitmatch=mod$data$traitmatch,model=x)\nmodlist[[x]]<-d\n}\nmodlist<-rbind_all(modlist)\nggplot(modlist,aes(x=traitmatch,y=R_effect,col=as.factor(model))) + geom_line() + labs(col=\"Model\",x=\"Difference in Bill and Corolla Length\",y=\"Effect of resources on trait-matching\") + geom_point() + theme_bw()\n```\n\n* Model 1: Increased resources has no effect on trait-matching\n* Model 2: Increased resources has positive effect on visitation\n* Model 3: Increased resources has negative effect on visitation\n* Model 4: As resources increase, hummingbirds interact **more** with plants that match their bill length. \n* Model 5: As resources increase, hummingbirds interact **less** with plants that match their bill length. \n\n\n#Incorporate incomplete detection\n\nLet's simulate Model 5 and add in unequal detection rates for each species.\n\n\n```{r,fig.width=11,fig.height=4}\n##Simulate Interactions\nh_species=3\nplant_species=10\nmonths=24\nphenology=1\n\n#Bill sizes\nBill<-rpois(h_species,10)\n\n#Corolla sizes\nCorolla<-rpois(plant_species,15)\n\n#Subtract both and take absolute value\ntraitmatch<-abs(sapply(Corolla,function(x) x - Bill)/10)\n\n#fill out for each month\ntraitarray<-array(NA,dim=c(h_species,plant_species,months))\n#fill for each month\nfor (x in 1:months){\n  traitarray[,,x]<-traitmatch \n}\n\n#simulate some poisson distributed resource counts for each replicate\n#this will be same for each species to start with.\nresources<-array(NA,dim=c(h_species,plant_species,months))\n\n#fill for each month\nfor (x in 1:months){\n  resources[,,x]<-rlnorm(1,4)  \n}\n\n#standardize predictors\n\nresources<-array(data=scale(resources),dim=c(h_species,plant_species,months))\n#traitarray<-array(data=scale(traitarray),dim=c(h_species,plant_species,months))\n\n#regression slope for trait-matching and resources\n#trait match\ngamma1=.5\nintercept<-2\nsigma_slope1<- 0.1\nsigma_intercept<- 0.1\n\n#resources\ngamma2=0\nsigma_slope2<- 0.1\n\n#resources * traitmatch\ngamma3=0.5\nsigma_slope3<- 0.1\n\n#draw values from hierarcichal distributions\nbeta1<-rnorm(h_species,gamma1,sigma_slope1)\nbeta2<-rnorm(h_species,gamma2,sigma_slope2)\nbeta3<-rnorm(h_species,gamma3,sigma_slope3)\n\nalpha<-rnorm(h_species,intercept,sigma_intercept)\n\n#fit regression\nlambda<-exp(alpha + beta1 * traitarray + beta2 * resources + beta3 * resources * traitarray)\n\ntrue_interactions<-array(data=sapply(lambda,function(x){rpois(1,x)}),dim=c(h_species,plant_species,months))\n\n#combine and melt into a single datafFrame\nmdat<-dcast(melt(list(y=true_interactions,traitmatch=traitarray,resources=resources)),Var1+Var2+Var3~L1)\n\nggplot(mdat,aes(col=resources,y=y,x=traitmatch)) + geom_point() + geom_smooth(aes(group=1),method=\"glm\",method.args = list(family = \"poisson\"),formula=y~x) + theme_bw() + labs(x=\"Bill-Corolla Difference\",y=\"Visits\",\"Hummingbird\") + ggtitle(\"Correlation in Simulated Data\") + labs(col=\"Available Resources\") + scale_color_continuous(low=\"blue\",high=\"red\")\n```\n\n## Create biased detection rates\n\n```{r,fig.width=7}\n#For each species loop through and create a replicate dataframe\nobs<-array(dim=c(h_species,plant_species,months))\n\ndetection= runif(h_species,0,0.5)\n\n#Which months are plants in bloom?\n#This is the phenology matrix\nsampled<-replicate(plant_species,rbinom(months,1,phenology))\nsampled[sampled==0]<-NA\n\nfor(x in 1:h_species){\n  for (y in 1:plant_species){\n    \n    #True State\n    ts<-true_interactions[x,y,]\n    \n    #detections and phenology\n    obs[x,y,]<-ts *sampled[,y]\n    }\n  }\n\n#plot observed state\nobs.state<-melt(obs)\ncolnames(obs.state)<-c(\"Hummingbird\",\"Plant\",\"Month\",\"Detections\")\n\n#turn NA's to 0\n#obs.state$Detections[is.na(obs.state$Detections)]<-0\n\nobs.state$Hummingbird<-as.factor(obs.state$Hummingbird)\nobs.state$Plant<-factor(obs.state$Plant,levels=1:plant_species)\n\n### True Interaction Matrix\n\ncolnames(mdat)<-c(\"Hummingbird\",\"Plant\",\"Month\",\"resources\",\"traitmatch\",\"y\")\ntrueplot<-ggplot(mdat,aes(y=as.factor(Plant),x=as.factor(Hummingbird),fill=y)) + geom_tile() + labs(x=\"Hummingbird\",y=\"Plant\",fill=\"Presence\") +  scale_fill_continuous(low=\"white\",high=\"red\",\"Visits\")\ntrueplot\n```\n\n\n### Model Fitting\n\n$$ Y_{i,j,k} \\sim Pois(\\lambda_{i,j,k}) $$\n\n$$log(\\lambda_{i,j,k})<-\\alpha_i + \\beta_i * abs(Bill_i - Corolla_j) * \\beta_2 * Resources_k + \\beta_3 * Resources_k * abs(Bill_i - Corolla_j) $$\n\n**Priors**\n\n$$\\alpha_i \\sim N(intercept,\\tau_{\\alpha})$$\n$$\\beta_{1,i} \\sim N(\\gamma_1i,\\tau_{\\beta_1})$$\n$$\\beta_{2,i} \\sim N(\\gamma_2i,\\tau_{\\beta_2})$$\n$$\\beta_{3,i} \\sim N(\\gamma_3i,\\tau_{\\beta_3})$$\n\n**Hyperpriors**\n\nGroup Level Means\n\n$$\\gamma_{1,i} \\sim N(0.001,0.001)$$\n$$\\gamma_{2,i} \\sim N(0.001,0.001)$$\n$$\\gamma_{3,i} \\sim N(0.001,0.001)$$\n$$ intercept \\sim N(0.001,0.001)$$\n\nGroup Level Variance\n\n$$\\tau_{\\alpha} \\sim Gamma(0.001,0.001)$$\n$$\\tau_\\beta1 \\sim Gamma(0.001,0.001)$$\n$$\\tau_\\beta2 \\sim Gamma(0.001,0.001)$$\n$$\\tau_\\beta3 \\sim Gamma(0.001,0.001)$$\n\n**Derived quantities**\n\n$$\\sigma_{int} = \\frac{1}{\\tau_{\\alpha}}^2$$\n$$\\sigma_{slope1} = \\frac{1}{\\tau_{\\beta_1}}^2$$\n$$\\sigma_{slope2} = \\frac{1}{\\tau_{\\beta_2}}^2$$\n$$\\sigma_{slope3} = \\frac{1}{\\tau_{\\beta_3}}^2$$\n\n#Hierarcichal Bayesian Model\n\n```{r,eval=T,strip.white=T}\n\n#Source model\nsource(\"Bayesian/Poisson.R\")\n\n#print model\nwriteLines(readLines(\"Bayesian/Poisson.R\"))\n\n#Input Data\nDat <- list(\n  Y=obs,\n  Birds=dim(obs)[1],\n  Plants=dim(obs)[2],\n  Months=dim(obs)[3],\n  resources=resources,\n  traitmatch=traitarray)\n\n#A blank Y matrix - all present\ninitY<-array(dim=c(Dat$Birds,Dat$Plants,Dat$Months),data=max(obs,na.rm=T))\ninitB<-as.numeric(matrix(nrow=h_species,ncol=1,data=.1))\n\n#Inits\nInitStage <- function(){list(beta1=initB,beta2=initB,beta3=initB,alpha=rep(.5,Dat$Birds),intercept=0,tau_alpha=0.1,tau_beta1=0.1,tau_beta2=0.1,tau_beta3=0.1,gamma1=0,gamma2=0,gamma3=0)}\n\n#Parameters to track\nParsStage <- c(\"alpha\",\"beta1\",\"beta2\",\"beta3\",\"intercept\",\"sigma_int\",\"sigma_slope1\",\"sigma_slope2\",\"sigma_slope3\",\"gamma1\",\"gamma2\",\"gamma3\")\n\n#MCMC options\n\nni <- 20000  # number of draws from the posterior\nnt <- max(c(1,ni*.0001))  #thinning rate\nnb <- ni*.95 # number to discard for burn-in\nnc <- 2  # number of chains\n\n#Jags\n\nm = jags(inits=InitStage,\n         n.chains=nc,\n         model.file=\"Bayesian/Poisson.jags\",\n         working.directory=getwd(),\n         data=Dat,\n         parameters.to.save=ParsStage,\n         n.thin=nt,\n         n.iter=ni,\n         n.burnin=nb,\n         DIC=T)\n```\n\n```{r}\npars<-extract_par(m)\n```\n\n##Assess Convergence\n\n```{r,cache=FALSE,eval=TRUE,fig.width=11,fig.height=5}\n###Chains\nggplot(pars[pars$par %in% c(\"alpha\",\"beta1\",\"beta2\",\"beta3\"),],aes(x=Draw,y=estimate,col=as.factor(Chain))) + geom_line() + facet_grid(par~species,scale=\"free\") + theme_bw() + labs(col=\"Chain\") + ggtitle(\"Detection Probability\")\n```\n\n```{r,fig.height=5,fig.width=11,eval=T}\nggplot(pars[pars$par %in% c(\"gamma1\",\"gamma2\",\"gamma3\",\"sigma_int\",\"sigma_slope1\",\"sigma_slope2\",\"sigma_slope3\"),],aes(x=Draw,y=estimate,col=as.factor(Chain))) + geom_line() + theme_bw() + labs(col=\"Chain\") + ggtitle(\"Trait-matching regression\") + facet_wrap(~par,scales=\"free\")\n```\n\n##Posteriors\n\n```{r,cache=FALSE,fig.width=7,fig.height=13}\n###Posterior Distributions\np<-ggplot(pars[pars$par %in% c(\"alpha\",\"beta1\",\"beta2\",\"beta3\"),],aes(x=estimate)) + geom_histogram() + ggtitle(\"Estimate of parameters\") + facet_grid(species~par,scales=\"free\") + theme_bw() + ggtitle(\"Species Posteriors\")\n\n#Add true values\ntr<-melt(data.frame(species=1:h_species,alpha=alpha,beta1=beta1,beta2=beta2,beta3=beta3),id.var='species')\ncolnames(tr)<-c(\"species\",\"par\",\"value\")\npsim<-p + geom_vline(data=tr,aes(xintercept=value),col='red',linetype='dashed',size=1)\n#ggsave(\"Figures/SimulationPosteriors.jpg\",dpi=300,height=8,width=8)\n```\n\n```{r,cache=FALSE,eval=TRUE,fig.height=13,fig.width=10}\np<-ggplot(pars[pars$par %in% c(\"gamma1\",\"gamma2\",\"gamma3\",\"intercept\",\"sigma_int\",\"sigma_slope1\",\"sigma_slope2\",\"sigma_slope3\"),],aes(x=estimate)) + geom_histogram() + ggtitle(\"Hierarchical Posteriors\") + facet_wrap(~par,scale=\"free\",nrow=2) + theme_bw() \n\n#Add true values\ntr<-melt(list(gamma1=gamma1,gamma2=gamma2,gamma3=gamma3,intercept=intercept,sigma_int=sigma_intercept,sigma_slope1=sigma_slope1,sigma_slope2=sigma_slope2,sigma_slope3=sigma_slope3))\n\ncolnames(tr)<-c(\"value\",\"par\")\n\npsim2<-p + geom_vline(data=tr,aes(xintercept=value),linetype='dashed',size=1,col=\"red\")\n#ggsave(\"Figures/SimulationH.jpg\",dpi=300,height=4,width=10)\ngrid.arrange(psim,psim2,heights=c(.6,.4))\n```\n\n****\n<span style=\"color:red; font-size=25\" >True values are the red dashed lines</span>\n\n##Predicted Relationship \n\n```{r,fig.height=4,fig.width=4}\n\ncastdf<-dcast(pars[pars$par %in% c(\"gamma1\",\"gamma2\",\"gamma3\",\"intercept\"),], Chain + Draw~par,value.var=\"estimate\")\n\ntrajF<-function(alpha,beta1,beta2,beta3,x,resources){\n  indat<-data.frame(alpha,beta1,beta2,beta3)\n  \n  #fit regression for each input estimate\n  sampletraj<-list()\n  \n  for (y in 1:nrow(indat)){\n    v=exp(indat$alpha[y] + indat$beta1[y] * x + indat$beta2[y] * resources + indat$beta3[y] * x*resources)\n    \n    sampletraj[[y]]<-data.frame(x=as.numeric(x),y=as.numeric(v))\n  }\n  \n  sample_all<-rbind_all(sampletraj)\n  \n  #Compute CI intervals\n  predy<-group_by(sample_all,x) %>% summarise(lower=quantile(y,0.025,na.rm=T),upper=quantile(y,0.975,na.rm=T),mean=mean(y,na.rm=T))\n}\n\n#calculate interactions\n\nintF<-function(alpha,beta1,beta2,beta3,x,resources){\n  indat<-data.frame(alpha,beta1,beta2,beta3)\n  \n  #fit regression for each input estimate\n  sampletraj<-list()\n  \n  for (y in 1:nrow(indat)){\n    v=indat$beta2[y] + indat$beta3[y]  * x\n    sampletraj[[y]]<-data.frame(x=as.numeric(x),y=as.numeric(v))\n  }\n  \n  sample_all<-rbind_all(sampletraj)\n  \n  #Compute CI intervals\n  predy<-group_by(sample_all,x) %>% summarise(lower=quantile(y,0.025,na.rm=T),upper=quantile(y,0.975,na.rm=T),mean=mean(y,na.rm=T))\n}\n```\n\n## Calculated predicted visitation rates\n\n```{r}\n\npredy<-trajF(alpha=castdf$intercept,beta1=castdf$gamma1,x=as.numeric(traitarray),resources=resources,beta2=castdf$gamma2,beta3=gamma3)\n\norig<-trajF(alpha=rnorm(2000,intercept,sigma_intercept),beta1=rnorm(2000,gamma1,sigma_slope1),beta2=rnorm(2000,gamma2,sigma_slope2),beta3=rnorm(2000,gamma3,sigma_slope3),x=as.numeric(traitarray),resources=resources)\n\n#plot and compare to original data\npsim3<-ggplot(data=predy,aes(x=x)) + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.1,fill=\"red\")  + geom_line(aes(y=mean),size=.8,col=\"red\",linetype=\"dashed\") + theme_bw() + ylab(\"Interactions\") + geom_line(data=orig,aes(x=x,y=mean),col='black',size=1)+ xlab(\"Difference between Bill and Corolla Length\") + geom_point(data=mdat,aes(x=traitmatch,y=y))\n\npsim3\n#ggsave(\"Figures/SimulationResults.jpg\",height=5,width=6,dpi=300)\n```\n\n\n##Visualize interactions\n\n```{r}\npredyint<-intF(alpha=castdf$intercept,beta1=castdf$gamma1,x=as.numeric(traitarray),resources=resources,beta2=castdf$gamma2,beta3=gamma3)\n\norigint<-intF(alpha=rnorm(2000,intercept,sigma_intercept),beta1=rnorm(2000,gamma1,sigma_slope1),beta2=rnorm(2000,gamma2,sigma_slope2),beta3=rnorm(2000,gamma3,sigma_slope3),x=as.numeric(traitarray),resources=resources)\n\n#plot and compare to original data\npsim4<-ggplot(data=predyint,aes(x=x)) + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.3,fill=\"red\") + theme_bw() + ylab(\"Interactions\") + geom_line(data=origint,aes(x=x,y=mean),col='black',size=1) + geom_line(aes(y=mean),size=.8,col=\"red\",linetype=\"dashed\") + xlab(\"Difference between Bill and Corolla Length\") \n\npsim4\n```\n\n",
    "created" : 1457729289703.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "936856276",
    "id" : "7A76984B",
    "lastKnownWriteTime" : 1457739202,
    "path" : "~/NetworkPredict/PoissonSimulation.Rmd",
    "project_path" : "PoissonSimulation.Rmd",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "type" : "r_markdown"
}